<!DOCTYPE html>
<html>
<head>
    <title>Diagnose Views Issue</title>
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        body { font-family: system-ui; padding: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 10px 0; padding: 15px; background: #2a2a2a; border-radius: 8px; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .info { color: #3b82f6; }
        .code { background: #000; padding: 10px; border-radius: 5px; overflow-x: auto; font-family: monospace; white-space: pre; }
        button { background: #ff6500; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #ff8533; }
        iframe { width: 100%; height: 400px; border: 2px solid #ff6500; border-radius: 8px; margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Diagnose ProjectHub Views Issue</h1>
    
    <div class="test">
        <h2>Automated Diagnostics</h2>
        <button onclick="runDiagnostics()">Run Diagnostics</button>
        <button onclick="fixViews()">Try Auto-Fix</button>
        <div id="results"></div>
    </div>
    
    <iframe id="app-frame" src="http://localhost:8090"></iframe>
    
    <script>
        const results = document.getElementById('results');
        
        function log(message, type = 'info') {
            const div = document.createElement('div');
            div.className = type;
            div.innerHTML = message;
            results.appendChild(div);
        }
        
        async function waitForApp() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    try {
                        const iframe = document.getElementById('app-frame');
                        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const appElement = iframeDoc.querySelector('[x-data]');
                        if (appElement && appElement.__x) {
                            clearInterval(checkInterval);
                            resolve(appElement.__x.$data);
                        }
                    } catch (e) {
                        // Cross-origin, can't access iframe
                        clearInterval(checkInterval);
                        resolve(null);
                    }
                }, 500);
                
                // Timeout after 10 seconds
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve(null);
                }, 10000);
            });
        }
        
        async function runDiagnostics() {
            results.innerHTML = '';
            log('<strong>Running diagnostics...</strong>');
            
            // Test 1: Check if app loads
            log('1. Checking if app loads...');
            const app = await waitForApp();
            
            if (!app) {
                log('❌ Cannot access app data. Open the app directly and run these commands in the console:', 'error');
                log(`<div class="code">// Get app data
let app = document.querySelector('[x-data]').__x.$data;

// Check current state
console.log('Current View:', app.currentView);
console.log('Is Authenticated:', app.isAuthenticated);
console.log('Projects:', app.projects);
console.log('Tasks:', app.tasks);

// Switch to board
app.currentView = 'board';
console.log('Switched to board');

// Select first project if available
if (app.projects.length > 0) {
    app.selectedBoardProject = app.projects[0].id;
    app.loadBoardTasks();
}

// Switch to analytics
app.currentView = 'analytics';
app.calculateAnalytics();
setTimeout(() => app.updateCharts(), 500);</div>`, 'info');
                return;
            }
            
            // Test 2: Check authentication
            log('2. Checking authentication...');
            if (app.isAuthenticated) {
                log('✅ User is authenticated', 'success');
            } else {
                log('❌ User not authenticated. Please login first.', 'error');
                return;
            }
            
            // Test 3: Check data
            log('3. Checking data...');
            log(`Projects: ${app.projects.length}`, app.projects.length > 0 ? 'success' : 'error');
            log(`Tasks: ${app.tasks.length}`, app.tasks.length > 0 ? 'success' : 'error');
            log(`Current View: ${app.currentView}`, 'info');
            
            // Test 4: Try switching views
            log('4. Testing view switching...');
            
            // Test board view
            app.currentView = 'board';
            log('Switched to board view', 'info');
            
            if (app.projects.length > 0) {
                app.selectedBoardProject = app.projects[0].id;
                log(`Selected project: ${app.projects[0].name}`, 'success');
                await app.loadBoardTasks();
                log('Board tasks loaded', 'success');
            }
            
            // Test analytics view
            setTimeout(() => {
                app.currentView = 'analytics';
                log('Switched to analytics view', 'info');
                app.calculateAnalytics();
                setTimeout(() => {
                    app.updateCharts();
                    log('Analytics updated', 'success');
                }, 500);
            }, 1000);
        }
        
        async function fixViews() {
            results.innerHTML = '';
            log('<strong>Attempting to fix views...</strong>');
            
            log('Please run this code in the browser console while on ProjectHub:', 'info');
            log(`<div class="code">// Force reload everything
let app = document.querySelector('[x-data]').__x.$data;

// Ensure we're authenticated
if (!app.isAuthenticated) {
    alert('Please login first!');
    return;
}

// Load all data
Promise.all([
    app.loadProjects(),
    app.loadTasks()
]).then(() => {
    console.log('✅ Data loaded');
    
    // Initialize board
    if (app.projects.length > 0) {
        app.selectedBoardProject = app.projects[0].id;
        app.loadBoardTasks().then(() => {
            app.currentView = 'board';
            app.$nextTick(() => {
                app.initializeDragAndDrop();
                console.log('✅ Board initialized');
            });
        });
    }
    
    // Initialize analytics
    setTimeout(() => {
        app.currentView = 'analytics';
        app.calculateAnalytics();
        app.$nextTick(() => {
            app.updateCharts();
            console.log('✅ Analytics initialized');
        });
    }, 2000);
}).catch(err => {
    console.error('Error loading data:', err);
});</div>`, 'info');
        }
        
        // Instructions on load
        window.onload = () => {
            log('<strong>Instructions:</strong>', 'info');
            log('1. Make sure you are logged into ProjectHub in the iframe below', 'info');
            log('2. Click "Run Diagnostics" to check for issues', 'info');
            log('3. If diagnostics fail, open http://localhost:8090 directly and use the console commands provided', 'info');
        };
    </script>
</body>
</html>