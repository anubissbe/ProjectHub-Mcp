<!DOCTYPE html>
<html>
<head>
    <title>ProjectHub Auth Test</title>
</head>
<body>
    <h1>ProjectHub Authentication Test</h1>
    <div id="status">Testing...</div>
    <pre id="log"></pre>

    <script>
        const log = (msg) => {
            document.getElementById('log').innerHTML += msg + '\n';
            console.log(msg);
        };

        async function testAuth() {
            try {
                // Step 1: Login
                log('1. Logging in...');
                const loginRes = await fetch('http://localhost:3007/api/auth/login', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        email: 'admin@projecthub.local',
                        password: 'admin123'
                    })
                });
                
                const loginData = await loginRes.json();
                log('Login response: ' + JSON.stringify(loginData, null, 2));
                
                if (!loginData.accessToken) {
                    throw new Error('No token received');
                }
                
                // Store token as frontend would
                localStorage.setItem('access_token', loginData.accessToken);
                log('\n2. Token stored in localStorage as "access_token"');
                
                // Step 2: Test API call with token
                log('\n3. Testing /api/workspaces...');
                const token = localStorage.getItem('access_token');
                log('Token from localStorage: ' + token.substring(0, 20) + '...');
                
                const workspacesRes = await fetch('http://localhost:3007/api/workspaces', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                log('Workspaces response status: ' + workspacesRes.status);
                if (workspacesRes.ok) {
                    const workspaces = await workspacesRes.json();
                    log('Success! Workspaces: ' + JSON.stringify(workspaces, null, 2));
                    document.getElementById('status').innerHTML = '<span style="color: green">✓ Authentication is working!</span>';
                } else {
                    log('Error: ' + workspacesRes.status + ' ' + workspacesRes.statusText);
                    document.getElementById('status').innerHTML = '<span style="color: red">✗ Authentication failed</span>';
                }
                
            } catch (error) {
                log('Error: ' + error.message);
                document.getElementById('status').innerHTML = '<span style="color: red">✗ Test failed: ' + error.message + '</span>';
            }
        }
        
        testAuth();
    </script>
</body>
</html>